rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // Users 컬렉션
    // ============================================
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // 개발 환경: 모든 인증된 사용자 쓰기 가능

      // DragonBalls 서브컬렉션 - 사용자 본인만 접근 가능
      match /dragonBalls/{dragonBallId} {
        // 로그인한 사용자가 자신의 드래곤볼만 읽을 수 있음
        allow read: if request.auth != null && request.auth.uid == userId;
        // 로그인한 사용자가 자신의 드래곤볼만 수정할 수 있음
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Cart 서브컬렉션 - 사용자 본인만 접근 가능
      match /cart/{cartItemId} {
        // 로그인한 사용자가 자신의 장바구니만 읽을 수 있음
        allow read: if request.auth != null && request.auth.uid == userId;
        // 로그인한 사용자가 자신의 장바구니만 수정할 수 있음
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Favorites 서브컬렉션
      match /favorites/{favoriteId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // PriceAlerts 서브컬렉션
      match /priceAlerts/{alertId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ============================================
    // Parts 컬렉션
    // ============================================
    match /parts/{partId} {
      allow read: if true;
      allow write: if request.auth != null; // 인증된 사용자 쓰기 가능 (개발 환경)
    }

    // ============================================
    // BaseParts 컬렉션
    // ============================================
    match /base_parts/{basePartId} {
      allow read: if true;
      allow write: if request.auth != null; // 인증된 사용자 쓰기 가능 (개발 환경)
    }

    // baseParts (카멜케이스 버전)
    match /baseParts/{basePartId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ============================================
    // Listings 컬렉션
    // ============================================
    match /listings/{listingId} {
      allow read: if true; // 모든 사용자 읽기 가능
      allow create: if request.auth != null; // 인증된 사용자만 생성
      allow update: if request.auth != null; // 개발 환경: 모든 인증된 사용자 수정 가능
      allow delete: if request.auth != null; // 개발 환경: 모든 인증된 사용자 삭제 가능
    }

    // ============================================
    // Sell Requests 컬렉션
    // ============================================
    match /sell_requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null; // 개발 환경: 모든 인증된 사용자 생성 가능
      allow update: if request.auth != null; // 개발 환경: 모든 인증된 사용자 수정 가능
      allow delete: if request.auth != null; // 개발 환경: 모든 인증된 사용자 삭제 가능
    }

    // sellRequests (카멜케이스 버전)
    match /sellRequests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // ============================================
    // Orders 컬렉션
    // ============================================
    match /orders/{orderId} {
      allow read: if request.auth != null; // 개발 환경: 모든 인증된 사용자 읽기 가능
      allow create: if request.auth != null; // 개발 환경: 모든 인증된 사용자 생성 가능
      allow update: if request.auth != null; // 개발 환경: 모든 인증된 사용자 수정 가능
      allow delete: if request.auth != null; // 개발 환경: 모든 인증된 사용자 삭제 가능
    }

    // ============================================
    // Notifications 컬렉션
    // ============================================
    match /notifications/{notificationId} {
      allow read: if request.auth != null; // 개발 환경: 모든 인증된 사용자 읽기 가능
      allow create: if request.auth != null;
      allow update: if request.auth != null; // 개발 환경: 모든 인증된 사용자 수정 가능
      allow delete: if request.auth != null; // 개발 환경: 모든 인증된 사용자 삭제 가능
    }

    // ============================================
    // Price Alerts 컬렉션
    // ============================================
    match /priceAlerts/{alertId} {
      allow read: if request.auth != null; // 개발 환경
      allow write: if request.auth != null; // 개발 환경
    }

    // ============================================
    // Batch Shipments 컬렉션
    // ============================================
    match /batchShipments/{shipmentId} {
      allow read: if request.auth != null; // 개발 환경
      allow write: if request.auth != null; // 개발 환경
    }

    // ============================================
    // Cart 컬렉션
    // ============================================
    match /carts/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // Price History 컬렉션 (가격 스냅샷)
    // ============================================
    match /priceHistory/{snapshotId} {
      allow read: if true; // 모든 사용자 읽기 가능 (공개 데이터)
      allow write: if request.auth != null; // 인증된 사용자 쓰기 가능 (개발 환경)
    }

    // 기본적으로 모든 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
